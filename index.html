<!DOCTYPE html>
<html lang="it">
<head>
    <style>
        /* Aggiungi questo piccolo stile per l'indicatore */
        .refresh-notice { font-size: 0.6rem; opacity: 0.6; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

<script>
    const SUPABASE_URL = 'https://jnfnfszekfstuoiemkgf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZm5mc3pla2ZzdHVvaWVta2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODkzOTEsImV4cCI6MjA4MzQ2NTM5MX0.lh7eRFlg7nnI7kEzVPBL9kNyZWX-XFeWQxVbvmzRlvA';
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_PASS = "juvenilia1179";
    let isAdmin = false, isExpired = false, currentData = [], timerInterval;

    async function init() {
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        
        // Caricamento iniziale
        await ricaricaTutto();

        // FORZA AGGIORNAMENTO AUTOMATICO (POLLING)
        // Scarica i dati ogni 5 secondi senza bisogno di Replication
        setInterval(async () => {
            // Se l'utente non sta scrivendo nella ricerca, aggiorna la tabella
            const searchInput = document.getElementById('searchInput');
            if (document.activeElement !== searchInput) {
                await ricaricaTutto();
                console.log("Dati aggiornati automaticamente");
            }
        }, 5000); 
    }

    async function ricaricaTutto() {
        await caricaConfig();
        await caricaTabella();
    }

    // --- FUNZIONI DI CARICAMENTO (Modificate per non resettare la vista) ---

    async function caricaConfig() {
        try {
            const { data } = await _supabase.from('configurazione').select('*');
            if(!data) return;

            const titolo = data.find(c => c.chiave === 'titolo_gara')?.valore || "Gara Juvenilia";
            const scadenza = data.find(c => c.chiave === 'scadenza_adesioni')?.valore;

            if(document.getElementById('mainTitle').innerText !== titolo) {
                document.getElementById('mainTitle').innerText = titolo;
            }
            
            if (scadenza) {
                const diff = new Date(scadenza).getTime() - new Date().getTime();
                isExpired = diff <= 0;
                if (isExpired) {
                    mostraStatoTimer("ISCRIZIONI CHIUSE", "var(--danger)");
                } else {
                    startCountdown(scadenza);
                }
            } else {
                isExpired = false;
                mostraStatoTimer("TERMINE DA DEFINIRE", "var(--primary)");
            }
        } catch (e) { console.error("Errore config:", e); }
    }

    async function caricaTabella() {
        const { data } = await _supabase.from('presenze').select('*').order('nome');
        if(!data) return;
        
        // Confronto i dati per evitare di ridisegnare la tabella se nulla √® cambiato
        if (JSON.stringify(data) === JSON.stringify(currentData)) return;
        
        currentData = data;
        disegnaTabella();
    }

    function disegnaTabella() {
        const tbody = document.getElementById('tabella-body');
        const listContent = document.getElementById('listContent');
        tbody.innerHTML = '';
        listContent.innerHTML = '';
        
        let cSi = 0, cNo = 0;
        let partecipantiPerCat = {};

        currentData.forEach(p => {
            if (p.bloccato && !isAdmin) return;
            if(p.stato === 'si') {
                cSi++;
                if(!partecipantiPerCat[p.categoria]) partecipantiPerCat[p.categoria] = [];
                partecipantiPerCat[p.categoria].push(p.nome);
            }
            if(p.stato === 'no') cNo++;

            const tr = document.createElement('tr');
            if(p.stato === 'si') tr.className = 'bg-si';
            if(p.stato === 'no') tr.className = 'bg-no';
            
            const disabled = isExpired && !isAdmin ? 'disabled' : '';
            const displayAdmin = isAdmin ? 'table-cell' : 'none';

            tr.innerHTML = `
                <td class="col-admin" style="display:${displayAdmin}"><input type="checkbox" class="bulk-cb" value="${p.id}"></td>
                <td class="nome-cell">${p.nome}${p.bloccato ? ' üîí' : ''}</td>
                <td data-label="Categoria">${p.categoria}</td>
                <td data-label="Partecipa"><input type="radio" name="r_${p.id}" ${p.stato==='si'?'checked':''} ${disabled} onclick="salva('${p.id}','si')"></td>
                <td data-label="Non Partecipa"><input type="radio" name="r_${p.id}" ${p.stato==='no'?'checked':''} ${disabled} onclick="salva('${p.id}','no')"></td>
                <td data-label="Reset"><button class="action-btn" onclick="salva('${p.id}','vuoto')" ${disabled}>üîÑ</button></td>
                <td class="col-admin" style="display:${displayAdmin}">
                    <button class="action-btn" onclick="toggleLock('${p.id}', ${p.bloccato})">${p.bloccato?'üîí':'üîì'}</button>
                    <button class="action-btn" onclick="eliminaAtleta('${p.id}','${p.nome}')">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Aggiorna lista nomi per categoria
        const cats = Object.keys(partecipantiPerCat).sort();
        if(cats.length > 0) {
            document.getElementById('confirmedList').style.display = 'block';
            cats.forEach(cat => {
                const div = document.createElement('div');
                div.innerHTML = `<div class="cat-title">${cat}</div>`;
                partecipantiPerCat[cat].sort().forEach(n => div.innerHTML += `<span class="atleta-tag">${n}</span>`);
                listContent.appendChild(div);
            });
        }
        
        document.getElementById('count-si').innerText = cSi;
        document.getElementById('count-no').innerText = cNo;
        filterTable(); // Riapplica il filtro se l'utente stava cercando
    }

    async function salva(id, val) { 
        // Ottimizzazione: aggiorna subito l'interfaccia locale per velocit√†
        const { error } = await _supabase.from('presenze').update({ stato: val }).eq('id', id);
        if(!error) {
            showToast("Registrato");
            await ricaricaTutto();
        }
    }

    // ... (tutte le altre funzioni admin rimangono uguali) ...

    init();
</script>
</body>
</html>